<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProCheeser — Pro (Wood + AI + Online + Sound)</title>

  <!-- Chessboard CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

  <style>
    /* --- (your existing styles unchanged, trimmed for brevity) --- */
    :root{--bg-color:#212121;--panel-bg:#333;--accent-color:#f39c12;--text-color:#eee;--timer-bg:#000;--timer-text:#e74c3c;--timer-active:#2ecc71}
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--bg-color);color:var(--text-color);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:10px}
    h1{margin:0 0 20px 0;font-weight:700;letter-spacing:1px;color:var(--accent-color);text-transform:uppercase}
    .main-container{display:flex;flex-wrap:wrap;gap:30px;justify-content:center;align-items:flex-start;max-width:1100px;width:100%}
    .board-section{display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;max-width:450px}
    .timer-display{background:var(--timer-bg);color:var(--text-color);font-family:Courier New,Courier,monospace;font-size:2rem;font-weight:bold;padding:10px 20px;border-radius:6px;width:100%;text-align:center;box-sizing:border-box;border:2px solid #444;display:flex;justify-content:space-between;align-items:center}
    .timer-display.active{border-color:var(--timer-active);color:var(--timer-active);box-shadow:0 0 10px rgba(46,204,113,0.3)}
    .player-label{font-size:1rem;font-family:Segoe UI,sans-serif;text-transform:uppercase;color:#888}
    #myBoard{width:100%;touch-action:none}
    .controls-panel{background:var(--panel-bg);padding:25px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,0.3);width:100%;max-width:350px;display:flex;flex-direction:column;gap:15px}
    .status-box{background:#444;padding:15px;border-radius:8px;border-left:5px solid var(--accent-color)}
    .status-box h3{margin:0 0 5px 0;font-size:0.9rem;color:#aaa}
    .status-box p{margin:0;font-size:1.1rem;font-weight:bold}
    label{font-size:0.9rem;color:#ccc;margin-bottom:2px;display:block}
    select,button{width:100%;padding:12px;border-radius:6px;border:none;font-size:1rem;margin-bottom:10px;cursor:pointer;transition:all 0.2s}
    select{background:#555;color:white;outline:none}
    select:hover{background:#666}
    button.primary-btn{background:var(--accent-color);color:#212121;font-weight:bold}
    button.primary-btn:hover{background:#e67e22;transform:translateY(-2px)}
    button.secondary-btn{background:#555;color:white}
    button.secondary-btn:hover{background:#666}
    .btn-group{display:flex;gap:10px}
    .btn-group button{margin-bottom:0}
    .highlight-square{box-shadow:inset 0 0 3px 3px yellow}
    @media (max-width:700px){.main-container{flex-direction:column;align-items:center}.controls-panel{width:90%}.board-section{width:95%}}

    /* Wooden board squares override for chessboard.js classes */
    #myBoard .white-1e1d7 { background: #dcb88a !important; }
    #myBoard .black-3c85d { background: #8b5a2b !important; }

    /* Optional grain background (remove if you want plain colored squares) */
    #myBoard { background-image: url('/chess/assets/board/wood.jpg'); background-size: cover; border-radius:8px; padding:6px; box-sizing:border-box; }
  </style>
</head>
<body>
  <h1>ProCheeser</h1>

  <div class="main-container">
    <div class="board-section">
      <div id="timer-black-container" class="timer-display"><span class="player-label">Black</span><span id="time-b">10:00</span></div>
      <div id="myBoard"></div>
      <div id="timer-white-container" class="timer-display"><span class="player-label">White</span><span id="time-w">10:00</span></div>
    </div>

    <div class="controls-panel">
      <div class="status-box">
        <h3>Game Status</h3>
        <p id="statusText">Select settings and Start.</p>
      </div>

      <label for="gameMode">Mode</label>
      <select id="gameMode">
        <option value="ai">Play vs AI (Computer)</option>
        <option value="local">Pass & Play (Human vs Human)</option>
        <option value="online">Online Multiplayer</option>
      </select>

      <label for="timeControl">Timer Setting</label>
      <select id="timeControl">
        <option value="300">5 Minutes</option>
        <option value="600" selected>10 Minutes</option>
        <option value="1800">30 Minutes</option>
        <option value="3600">60 Minutes</option>
        <option value="999999">No Timer</option>
      </select>

      <div id="aiSettings">
        <label for="difficulty">Hardness Level</label>
        <select id="difficulty">
          <option value="1">Easy (Novice)</option>
          <option value="2">Medium (Casual)</option>
          <option value="3" selected>Hard (Pro)</option>
        </select>

        <label for="playerColor">Play As</label>
        <select id="playerColor">
          <option value="white">White</option>
          <option value="black">Black</option>
        </select>
      </div>

      <button class="primary-btn" id="startBtn">Start New Game</button>

      <div class="btn-group" id="undoRedoControls">
        <button class="secondary-btn" id="undoBtn">Undo</button>
        <button class="secondary-btn" id="redoBtn">Redo</button>
      </div>

      <button class="secondary-btn" id="resetBtn" style="margin-top:10px;">Reset Board</button>

      <hr style="border:none;border-top:1px solid #555;margin:6px 0">
      <strong style="color:#ccc;font-size:0.9rem">Online / Multiplayer</strong>
      <div style="display:flex;gap:8px">
        <input id="roomIdInput" placeholder="Room ID (or leave blank to create)" style="flex:1;padding:8px;border-radius:6px;border:none;background:#444;color:#eee">
        <button id="joinRoomBtn" class="secondary-btn">Create / Join</button>
      </div>
      <small style="color:#aaa">To invite, share Room ID displayed after creating a room.</small>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <!-- Stockfish (CDN build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js"></script>
  <!-- We'll create a worker from STOCKFISH() if available, else fallback to worker file -->

  <!-- Firebase (CDN modular imports will be used in inline module script) -->
  <!-- Note: we'll import firebase modules inside a <script type="module"> -->

  <script>
    /* ----------------------------
       Core game vars & UI helpers
       ---------------------------- */
    var board = null;
    var game = new Chess();
    var $status = $('#statusText');

    var gameMode = 'ai';
    var aiDepth = 3;                // maps to Stockfish skill / depth roughly
    var playerColor = 'white';
    var isAiThinking = false;

    var timerInterval = null;
    var whiteTime = 600, blackTime = 600;
    var gameActive = false, timerStarted = false;
    var redoStack = [];

    // Stockfish engine wrapper
    var engine = null;
    var engineReady = false;

    // Online multiplayer
    var firebaseApp = null;
    var database = null;
    var currentRoomId = null;
    var isHost = false;
    var onlineUnsub = null; // to detach DB listener

    // Audio (WebAudio)
    var audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    function beep(freq,dur,when=0){ ensureAudio(); var o=audioCtx.createOscillator(); var g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.0001,audioCtx.currentTime+when); g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+when+0.01); o.start(audioCtx.currentTime+when); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+when+dur); o.stop(audioCtx.currentTime+when+dur+0.02); }
    function playMoveSound(){ beep(880,0.06); }
    function playCaptureSound(){ beep(600,0.06); beep(400,0.04,0.06); }
    function playCheckSound(){ beep(1200,0.12); }
    function playGameOverSound(){ beep(200,0.6); }

    /* ----------------------------
       Init board & UI
       ---------------------------- */
    function initGame() {
      stopTimer();
      timerStarted = false;
      gameMode = $('#gameMode').val();
      aiDepth = parseInt($('#difficulty').val()) || 3;
      playerColor = $('#playerColor').val();
      var startSeconds = parseInt($('#timeControl').val());
      whiteTime = startSeconds; blackTime = startSeconds;
      gameActive = true;
      updateTimerDisplay();

      // show/hide controls
      if (gameMode === 'local') {
        $('#aiSettings').hide(); $('#undoRedoControls').hide();
      } else if (gameMode === 'online') {
        $('#aiSettings').hide(); $('#undoRedoControls').hide();
      } else {
        $('#aiSettings').show(); $('#undoRedoControls').show();
      }

      game.reset();
      redoStack = [];
      isAiThinking = false;

      // board config using local pieces
      var config = {
        draggable: true,
        position: 'start',
        pieceTheme: '/chess/assets/pieces/wood/{piece}.png',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onSnapEnd: onSnapEnd
      };

      board = Chessboard('myBoard', config);
      board.orientation(playerColor);

      updateStatus();

      // If AI plays White, let it go first
      if (gameMode === 'ai' && playerColor === 'black') {
        setTimeout(makeAiMove, 250);
      }

      // If online mode and already in room subscribe
      if (gameMode === 'online' && currentRoomId) {
        subscribeToRoom(currentRoomId);
      } else {
        if (onlineUnsub) { onlineUnsub(); onlineUnsub = null; }
      }
    }

    /* ----------------------------
       Timer functions
       ---------------------------- */
    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerStarted = true;
      timerInterval = setInterval(function(){
        if (!gameActive) return;
        if (game.turn() === 'w') { whiteTime--; if (whiteTime <= 0) endGameByTime('White'); }
        else { blackTime--; if (blackTime <= 0) endGameByTime('Black'); }
        updateTimerDisplay();
      },1000);
    }
    function stopTimer(){ if (timerInterval) clearInterval(timerInterval); timerInterval=null; }
    function endGameByTime(colorWhoLost){
      gameActive = false; stopTimer();
      $status.text('Game Over! ' + colorWhoLost + ' ran out of time.');
      playGameOverSound();
      alert(colorWhoLost + " ran out of time! Game Over.");
    }
    function updateTimerDisplay(){
      function formatTime(t){ if(t>90000) return "∞"; var min=Math.floor(t/60); var sec=t%60; return (min<10?"0"+min:min)+":"+(sec<10?"0"+sec:sec); }
      $('#time-w').text(formatTime(whiteTime));
      $('#time-b').text(formatTime(blackTime));
      if (gameActive && timerStarted) {
        if (game.turn() === 'w') { $('#timer-white-container').addClass('active'); $('#timer-black-container').removeClass('active'); }
        else { $('#timer-black-container').addClass('active'); $('#timer-white-container').removeClass('active'); }
      } else { $('.timer-display').removeClass('active'); }
    }

    /* ----------------------------
       Drag/Drop & Highlights
       ---------------------------- */
    function onDragStart(source, piece, position, orientation){
      if (game.game_over() || !gameActive || isAiThinking) return false;
      if (whiteTime <= 0 || blackTime <= 0) return false;
      if (gameMode === 'ai') {
        if ((playerColor === 'white' && piece.search(/^b/) !== -1) || (playerColor === 'black' && piece.search(/^w/) !== -1)) {
          return false;
        }
      }
    }

    function onDrop(source, target) {
      var move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';

      // sound
      if (move.captured) playCaptureSound(); else playMoveSound();
      if (game.in_check()) playCheckSound();

      // clear redo on new move
      redoStack = [];

      if (!timerStarted) startTimer();
      updateStatus();
      updateTimerDisplay();

      board.position(game.fen());

      // If online mode, push move to Firebase
      if (gameMode === 'online' && currentRoomId) {
        pushMoveToRoom(currentRoomId, game.fen(), move.san);
      }

      // If AI mode, compute AI move
      if (gameMode === 'ai' && !game.game_over()) {
        isAiThinking = true;
        $status.text("AI is thinking...");
        setTimeout(makeAiMove, 120); // small delay for UX
      }
    }

    function onSnapEnd(){ board.position(game.fen()); }

    function removeGreySquares(){ $('#myBoard .square-55d63').css('background',''); }
    function greySquare(square){
      var $square = $('#myBoard .square-' + square);
      var background = '#a9a9a9'; if ($square.hasClass('black-3c85d')) background = '#696969';
      $square.css('background', background);
    }
    function onMouseoverSquare(square, piece){
      if (game.game_over() || !gameActive || isAiThinking) return;
      if (gameMode === 'ai') {
        var turn = game.turn() === 'w' ? 'white' : 'black';
        if (turn !== playerColor) return;
      }
      var moves = game.moves({ square: square, verbose: true });
      if (moves.length === 0) return;
      greySquare(square);
      for (var i = 0; i < moves.length; i++) greySquare(moves[i].to);
    }
    function onMouseoutSquare(square,piece){ removeGreySquares(); }

    /* ----------------------------
       Undo / Redo
       ---------------------------- */
    $('#undoBtn').on('click', function(){
      if (gameMode === 'local' || !gameActive || isAiThinking) return;
      var move1 = game.undo(); if (!move1) return; redoStack.push(move1);
      var justMovedColor = move1.color;
      // if we undid player's move and AI had moved, undo one more (AI) to revert full ply
      if (gameMode === 'ai' && justMovedColor !== playerColor.charAt(0)) {
        var move2 = game.undo(); if (move2) redoStack.push(move2);
      }
      board.position(game.fen());
      updateStatus();
    });

    $('#redoBtn').on('click', function(){
      if (gameMode === 'local' || !gameActive || isAiThinking) return;
      if (redoStack.length === 0) return;
      var move = redoStack.pop();
      game.move(move);
      if (redoStack.length > 0) {
        var nextMove = redoStack[redoStack.length - 1];
        if (nextMove.color !== playerColor.charAt(0)) game.move(redoStack.pop());
      }
      board.position(game.fen());
      updateStatus();
    });

    /* ----------------------------
       Status text
       ---------------------------- */
    function updateStatus(){
      var status = '';
      var moveColor = (game.turn() === 'b') ? 'Black' : 'White';
      if (game.in_checkmate()) { status = 'Game Over: ' + moveColor + ' is in checkmate.'; gameActive=false; stopTimer(); alert(status); playGameOverSound(); }
      else if (game.in_draw()) { status = 'Game Over: Drawn position'; gameActive=false; stopTimer(); }
      else {
        if (!timerStarted) status = 'Waiting for First Move...';
        else { status = moveColor + ' to move'; if (game.in_check()) status += ' (CHECK!)'; }
      }
      $status.text(status);
    }

    /* ----------------------------
       Stockfish AI Integration
       ---------------------------- */
    function ensureEngine() {
      if (engine && engineReady) return;
      engineReady = false;
      // If STOCKFISH factory is available (from stockfish.js), use it to create worker
      try {
        if (typeof STOCKFISH === 'function') {
          engine = STOCKFISH();
        } else if (typeof Stockfish === 'function') {
          engine = Stockfish();
        } else {
          // fallback: try Worker path (some CDNs expose stockfish.worker.js)
          engine = new Worker('https://cdn.jsdelivr.net/npm/stockfish.js@10.0.2/stockfish.js');
        }
      } catch (e) {
        console.warn('Stockfish engine init failed, falling back to builtin simple AI.', e);
        engine = null;
        return;
      }

      if (!engine) return;

      engine.onmessage = function(event) {
        var line = (typeof event === 'string') ? event : (event.data || event);
        // stockfish responds with lines — look for "bestmove"
        if (typeof line === 'string' && line.indexOf('bestmove') === 0) {
          var parts = line.split(' ');
          if (parts[1]) {
            var best = parts[1].trim();
            if (best && best !== '(none)') {
              // apply move: best is like e2e4 or e7e8q
              game.move({ from: best.substring(0,2), to: best.substring(2,4), promotion: best.length>4? best[4] : 'q' });
              board.position(game.fen());
              isAiThinking = false;
              updateStatus();
              updateTimerDisplay();
              playMoveSound();
            }
          }
        }
      };

      // initialize UCI
      try {
        engine.postMessage('uci');
        engine.postMessage('isready');
        engineReady = true;
      } catch(e){ console.warn('engine postMessage fail', e); engineReady=false; }
    }

    function makeAiMove() {
      if (game.game_over() || !gameActive) { isAiThinking=false; return; }
      // Use Stockfish if available, else fallback to simple evaluator
      ensureEngine();
      if (engine && engineReady) {
        // set skill / depth: we'll pass 'go depth X'
        // set position
        engine.postMessage('ucinewgame');
        engine.postMessage('position fen ' + game.fen());
        // tuning: map aiDepth 1/2/3 => depth 8/12/16
        var mapping = {1:8, 2:12, 3:16};
        var depth = mapping[aiDepth] || 12;
        engine.postMessage('go depth ' + depth);
      } else {
        // fallback (random / simple search)
        var moves = game.moves();
        var move = moves[Math.floor(Math.random()*moves.length)];
        game.move(move);
        board.position(game.fen());
        isAiThinking=false;
        updateStatus();
        playMoveSound();
      }

      // start timer if AI made first move
      if (!timerStarted) startTimer();
    }

    /* ----------------------------
       Simple online multiplayer (Firebase)
       - Basic room create/join and move sync using FEN string.
       - This is a minimal example for real-time syncing. For production,
         add authentication, security rules, and conflict resolution.
       ---------------------------- */

    // NOTE: firebase modules are imported in module script below; these functions
    // assume `database` is the Realtime Database instance.

    function pushMoveToRoom(roomId, fen, san) {
      if (!database) return;
      var roomRef = firebase.database().ref('rooms/' + roomId);
      roomRef.update({
        fen: fen,
        lastSan: san,
        timestamp: Date.now()
      });
    }

    function subscribeToRoom(roomId) {
      if (!firebase || !firebase.database) return;
      // detach previous
      if (onlineUnsub) { onlineUnsub(); onlineUnsub=null; }
      var roomRef = firebase.database().ref('rooms/' + roomId);
      var listener = function(snapshot) {
        var val = snapshot.val();
        if (!val) return;
        // If fen differs from current game and was updated by remote, update board
        if (val.fen && val.fen !== game.fen()) {
          // apply remote position
          game.load(val.fen);
          board.position(game.fen());
          updateStatus();
        }
      };
      roomRef.on('value', listener);
      onlineUnsub = function(){ roomRef.off('value', listener); };
    }

    // Create or join a room (simple flow)
    $('#joinRoomBtn').on('click', async function(){
      var pref = $('#roomIdInput').val().trim();
      if (!firebase || !firebase.database) {
        alert('Firebase not configured. See instructions in the top of the file and paste your config.');
        return;
      }
      if (pref) {
        currentRoomId = pref;
        isHost = false;
        subscribeToRoom(currentRoomId);
        alert('Joined room: ' + currentRoomId);
        // If room has fen, load it
        var roomRef = firebase.database().ref('rooms/' + currentRoomId + '/fen');
        roomRef.once('value').then(function(snap){ var fen = snap.val(); if (fen) { game.load(fen); board.position(game.fen()); updateStatus(); } });
      } else {
        // create random short id
        var id = Math.random().toString(36).slice(2,9);
        currentRoomId = id;
        isHost = true;
        // push initial state
        firebase.database().ref('rooms/' + currentRoomId).set({
          fen: game.fen(),
          created: Date.now()
        }).then(function(){
          subscribeToRoom(currentRoomId);
          alert('Created room: ' + currentRoomId + '\nShare this ID to invite.');
          $('#roomIdInput').val(currentRoomId);
        });
      }
      // switch to online mode UI and settings for clarity
      $('#gameMode').val('online');
      initGame();
    });

    /* ----------------------------
       Start / Reset handlers
       ---------------------------- */
    $('#startBtn').on('click', initGame);
    $('#resetBtn').on('click', initGame);
    $('#gameMode').on('change', initGame);

    $(document).ready(function(){
      initGame();
      setupFirebaseModuleLoader(); // load firebase modules and wire firebase variable
    });

    /* ----------------------------
       Firebase Module Loader (imports modular SDK via runtime module)
       We do this so we can keep the rest of the code non-module and
       still use CDN imports (the recommended approach).
       ---------------------------- */
    function setupFirebaseModuleLoader(){
      // We'll dynamically create a module script that imports and sets a global `firebase` namespace
      // This keeps the rest of the code simpler (uses window.firebase)
      var moduleScript = document.createElement('script');
      moduleScript.type = 'module';
      moduleScript.text = `
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, update, get, child } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

        // TODO: Replace the firebaseConfig object below with your project's values.
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_AUTH_DOMAIN",
          databaseURL: "YOUR_DATABASE_URL",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_STORAGE_BUCKET",
          messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
          appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // expose a tiny compatibility layer on window.firebase (Realtime DB subset)
        window.firebase = {
          app: app,
          database: db,
          databaseRef: ref,
          databaseOnValue: onValue,
          databaseSet: set,
          databaseUpdate: update,
          databaseGet: get,
          databaseChild: child,
          // provide simple wrappers so other code can call firebase.database().ref(...)
          databaseRefFactory: function(path){ return ref(db, path); },
          // convenience: legacy-style firebase.database() object
          databaseLegacy: {
            ref: function(path){ return ref(db, path); },
            on: function(path, cb){ var r = ref(db, path); onValue(r, (s)=>cb({ val: ()=>s.val() })); },
            off: function(){ /* no op for simple wrapper */ }
          }
        };

        // also expose short helpers for compatibility (window.firebase.database() returns object)
        window.firebase.database = function(){ return { ref: function(p){ return ref(db,p); }, on: function(p,cb){ var r=ref(db,p); onValue(r, (s)=>cb({ val: ()=>s.val() })); } } };
        console.log('Firebase modules loaded (CDN).');
      `;
      document.body.appendChild(moduleScript);
    }

    /* ----------------------------
       Helpful note:
       - After you paste your Firebase config into the module above (the TODO),
         reload the page, then use the "Create / Join" button to create a room or join an existing ID.
       - This example uses Realtime Database updating a `rooms/{roomId}/fen` key with the current FEN.
         It is minimal: for production you must add Authentication and Database Rules!
       ---------------------------- */
  </script>
</body>
</html>
